<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallbridge Work Delivery Tracker</title>
    <!-- Chart.js for Analytics Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FullCalendar for Calendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <!-- html2pdf.js for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { color: #333; text-align: center; }
        .container { display: none; } /* Hidden until data added */
        .input-section {
            background: white;
            padding: 20px;
            margin: 0 auto 20px auto; /* Centers horizontally; keeps bottom margin */
            max-width: 1800px; /* Adjust this: e.g., 1000px for narrower, 1400px for wider */
            width: 95%; /* Fills most of the screen on smaller displays */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #4CAF50; color: white; }
        #dataTable th:nth-child(10), #dataTable td:nth-child(10) { min-width: 200px; }
        #dataTable td:nth-child(6), #dataTable th:nth-child(6) { text-align: center; }
        .filter-toggle { background: #2196F3; color: white; padding: 5px 10px; border: none; cursor: pointer; margin-bottom: 10px; }
        .filter-row { display: none; background-color: #f9f9f9; }
        .filter-row.show { display: table-row; }
        .filter-row th { padding: 8px; vertical-align: top; } /* Matches new uniform padding */
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { display: block; margin: 2px 0; font-size: 12px; cursor: pointer; }
        .filter-group input[type="checkbox"] { margin-right: 5px; }
        /* Removed even row grey background */
        .status-got-time, .status-complete { background-color: #e8f5e8 !important; color: #2e7d32; }
        .status-complete { background-color: #2e7d32 !important; color: white; }
        .status-at-risk { background-color: #fff3e0 !important; color: #ef6c00; }
        .status-overdue { background-color: #ffebee !important; color: #c62828; }
        .progress-not-started { color: #9E9E9E; }
        .progress-in-progress { color: #FF9800; }
        .progress-submitted { color: #2196F3; }
        .progress-complete-accepted { color: #2e7d32; }
        .chart-container { position: relative; height: 400px; width: 80%; margin: 0 auto 20px auto; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; display: flex; justify-content: center; align-items: center; }
        canvas { max-width: 100%; max-height: 100%; }
        .calendar-container, .gantt-container { position: relative; height: auto; width: 100%; margin-bottom: 20px; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-x: auto; overflow-y: visible; }
        .fallback-gantt { height: 400px; width: 80%; margin: 0 auto; }
        .analytics { display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: wrap; }
        .analytic-card { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; flex: 1; min-width: 150px; margin: 5px; }
        #alerts h3 { color: #333; margin-top: 20px; }
        #alerts ul { list-style-type: none; padding: 0; }
        #alerts li { background: #f9f9f9; margin: 5px 0; padding: 10px; border-left: 4px solid #4CAF50; }
        button { background: #4CAF50; color: white; padding: 10px; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        select, input, textarea {
            width: 100%;
            padding: 1px;
            border: 1px solid #ddd;
            box-sizing: border-box; /* Includes border in width, so it fits flush */
            margin: 0;
        }
        #dataTable td:nth-child(4) input[type="text"] {
            width: 120px; /* Adjust this value: e.g., 100px for narrower, 150px for wider */
            margin: 0 auto; /* Centers the input box in the cell if needed */
            display: block; /* Ensures it behaves as a block for centering */
            padding: 1px;
        }
        textarea { height: 40px; resize: vertical; padding: 1px;}
        #addRow { margin-bottom: 10px; }
        #debug { color: red; font-size: 12px; margin-top: 10px; text-align: center; }
        .calendar-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px; }
        #calTitle { font-weight: bold; font-size: 16px; }
        /* Gantt */
        .gantt-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        .gantt-container {
            background: #ffffff;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            margin-bottom: 2rem;
            overflow-x: auto;
            /* Increased height to allow more rows without vertical scrolling */
            max-height: none;
            height: auto;
        }
        #gantt table {
            font-size: 0.875rem;
            border-collapse: collapse;
            width: max-content;
            min-width: 2500px; /* Increased for extended timeline */
            table-layout: fixed;
        }
        #gantt th, #gantt td {
            border: 1px solid #e2e8f0;
            height: 20px;
            text-align: center;
            vertical-align: middle;
            position: relative;
            color: #0f172a;
            padding: 0.5rem;
        }
        #gantt th.week-start, #gantt td.task-cell {
            width: 35px; /* Increased from 25px for better visibility */
            min-width: 35px;
        }
        #gantt th.left-header {
            width: 300px; /* Slightly increased for longer task names */
            background: #ffffff;
        }
        #gantt th.year-header {
            background: #f1f5f9;
            font-weight: 600;
            color: #0f172a;
        }
        #gantt th.month {
            background: #e2e8f0;
            font-weight: 500;
            color: #0f172a;
        }
        #gantt th.week-start {
            background: #f8fafc;
            color: #64748b;
        }
        #gantt td.task-cell {
            background: #ffffff;
        }
        #gantt .phase-header {
            background: #f1f5f9 !important;
            font-weight: 600;
            text-align: left;
            padding-left: 1rem;
            color: #0f172a;
            border: 2px solid #e2e8f0;
        }
        #gantt .type-header {
            background: #e2e8f0 !important;
            font-style: italic;
            text-align: left;
            padding-left: 1rem;
            color: #64748b;
        }
        #gantt .task-name {
            font-weight: 400;
            color: #0f172a;
            text-align: left;
            padding-left: 1rem;
            background: #ffffff;
        }
        /* Sticky first column for Gantt */
        #gantt thead th:first-child,
        #gantt tbody td:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            border-right: none !important;
        }
        #gantt .phase-header:first-child,
        #gantt .type-header:first-child,
        #gantt .task-name {
            border-right: none !important;
        }
        /* Calendar Today Highlight */
        #calendar .fc-daygrid-day.fc-day-today,
        #calendar .fc-multimonth-day.fc-day-today {
            background-color: #FFD700 !important;
        }
        /* Modal Styles */
        #modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        #modalContent {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            max-height: 70%;
            overflow-y: auto;
        }
        #closeModal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        #closeModal:hover {
            color: black;
        }
        /* CSV Import Styles */
        .csv-import {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .csv-import.dragover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        .csv-import input[type="file"] {
            display: none;
        }
        .charts-row {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }
        .chart-section {
            flex: 1;
            min-width: 400px;
            background: white;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #toggleTable {
            background: #2196F3;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Wallbridge Work Delivery Tracker</h1>
    <!-- Input Section -->
    <div class="input-section" id="inputSection">
        <h2>Add/Edit Data</h2>
        <button id="addRow">Add New Row</button>
        <button id="toggleTable">Hide Table</button>
        <div class="csv-import" id="csvImport">
            <p>Drag & drop CSV here or <button id="browseCsv">Browse CSV</button></p>
            <p>Fetch CSV from: \\wmfensrvfs1\projects\3_Land_Management\Work_Tracker\Work_Delivery_Tracker.csv</p>
            <input type="file" id="csvFile" accept=".csv">
        </div>
        <button id="toggleFilters" class="filter-toggle">Filters</button>
        <table id="dataTable" style="display: block;">
            <thead>
                <tr>
                    <th>Assignment Name</th>
                    <th>Type</th>
                    <th>Project Name</th>
                    <th>Responsible</th>
                    <th>Delivery Date</th>
                    <th>Days to Delivery</th>
                    <th>Deadline Date</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <button id="generateDashboard">Generate Dashboard</button>
        <div id="debug"></div>
    </div>
    <!-- Dashboard Section -->
    <div id="dashboard" class="container">
        <h2>Analytics</h2>
        <div class="analytics">
            <div class="analytic-card">
                <h3>Total Tasks</h3>
                <p id="totalTasks">0</p>
            </div>
            <div class="analytic-card">
                <h3>Got Time</h3>
                <p id="gotTimeCount">0</p>
            </div>
            <div class="analytic-card">
                <h3>At Risk</h3>
                <p id="atRiskCount">0</p>
            </div>
            <div class="analytic-card">
                <h3>Overdue</h3>
                <p id="overdueCount">0</p>
            </div>
            <div class="analytic-card">
                <h3>Not Started</h3>
                <p id="notStartedCount">0</p>
            </div>
            <div class="analytic-card">
                <h3>In Progress</h3>
                <p id="inProgressCount">0</p>
            </div>
            <div class="analytic-card">
                <h3>Submitted</h3>
                <p id="submittedCount">0</p>
            </div>
            <div class="analytic-card">
                <h3>Complete/Accepted</h3>
                <p id="completeAcceptedCount">0</p>
            </div>
        </div>
        <h2>Calendar View</h2>
        <div class="calendar-controls">
            <button id="calPrev">Previous Month</button>
            <button id="calToday">Today</button>
            <button id="calNext">Next Month</button>
            <span id="calTitle"></span>
        </div>
        <div class="calendar-container">
            <div id="calendar"></div>
        </div>
        <h2>Extended Gantt Chart</h2>
        <div class="gantt-controls">
        </div>
        <div class="gantt-container">
            <div id="gantt"></div>
        </div>
        <h2>Upcoming Alerts</h2>
        <div id="alerts"></div>
        <h2>Charts</h2>
        <div class="charts-row">
            <div class="chart-section">
                <h3>Status Breakdown Chart</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-section">
                <h3>Progress Breakdown Chart</h3>
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Calendar Popup -->
    <div id="modal">
        <div id="modalContent">
            <span id="closeModal">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>
    <script>
        // Wait for DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            // Data storage - start empty by default
            let data = [];
            // Removed localStorage load to ensure no data by default
            const predefinedTypes = ['Assessment Report', 'Permit Application', 'Other'];
            const predefinedProjects = ['Martiniere', 'Fenelon', 'Casault', 'Harri', 'Grasset', 'Doigt','Detour East JV'];
            const progressOptions = ['Not Started', 'In Progress', 'Submitted', 'Complete/Accepted'];
            const statusOptions = ['Got Time', 'At Risk', 'Overdue', 'Complete'];
            const typeColors = {
                'Assessment Report': { safe: '#FFDCB8', atrisk: '#FFB05C', complete: '#F57E00' },
                'Permit Application': { safe: '#90CAF9', atrisk: '#2196F3', complete: '#0D47A1' },
                'Other': { safe: '#CE93D8', atrisk: '#9C27B0', complete: '#4A148C' },
                'Claim Renewal': { safe: '#D7CCC8', atrisk: '#A1887F', complete: '#946A3E' }
            };
            // Dynamic today date - normalized to midnight in local timezone
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // Helper function to get local date string (YYYY-MM-DD)
            function getLocalDateString(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            function computeStatus(daysToDelivery) {
                if (daysToDelivery > 30) return 'Got Time';
                if (daysToDelivery > 0) return 'At Risk';
                return 'Overdue';
            }
            function isValidDate(dateStr) {
                if (!dateStr) return false;
                const date = new Date(dateStr);
                return !isNaN(date.getTime()) && dateStr === date.toISOString().split('T')[0];
            }
            function normalizeProgress(p) {
                if (!p) return 'Not Started';
                p = p.trim().toLowerCase();
                if (p.includes('not started') || p.includes('pending') || p.includes('ns')) return 'Not Started';
                if (p.includes('in progress') || p.includes('ongoing') || p.includes('ip')) return 'In Progress';
                if (p.includes('submitted') || p.includes('sent') || p.includes('sub')) return 'Submitted';
                if (p.includes('complete') || p.includes('accepted') || p.includes('done') || p.includes('ca')) return 'Complete/Accepted';
                // If no match, default to 'Not Started' or keep original? For safety, default
                return 'Not Started';
            }
            function getFlattened(items, parentId = null, depth = 0) {
                return items
                    .filter(item => item.parentId === parentId)
                    .sort((a, b) => {
                        if ((a.project || '') !== (b.project || '')) return (a.project || '').localeCompare(b.project || '');
                        const dateA = new Date(a.deadlineDate || a.deliveryDate || '9999-12-31T00:00:00Z');
                        const dateB = new Date(b.deadlineDate || b.deliveryDate || '9999-12-31T00:00:00Z');
                        return dateA.getTime() - dateB.getTime();
                    })
                    .flatMap(item => [{ ...item, depth }, ...getFlattened(items, item.id, depth + 1)]);
            }
            function getChildren(parentId, items = data) {
                return items.filter(i => i.parentId === parentId);
            }
            // Safe destroy function
            function safeDestroy(chartVar) {
                if (window[chartVar] && typeof window[chartVar].destroy === 'function') {
                    try {
                        window[chartVar].destroy();
                    } catch (e) {
                        console.warn('Destroy failed for ' + chartVar + ':', e);
                    }
                }
                window[chartVar] = null;
            }
            // Function to update dashboard if visible
            function updateDashboardIfVisible() {
                if (document.getElementById('dashboard').style.display === 'block') {
                    generateDashboard();
                }
            }
            // CSV Import Functions
            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\s+/g, '_'));
                const rows = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                    return headers.reduce((obj, header, i) => {
                        obj[header] = values[i] || '';
                        return obj;
                    }, {});
                });
                return rows;
            }
            // Helper function to normalize date format to YYYY-MM-DD
            function normalizeDateFormat(dateStr) {
                if (!dateStr || dateStr.trim() === '') return '';

                // Try to parse the date
                const parsed = new Date(dateStr);
                if (isNaN(parsed.getTime())) return '';

                // Return in YYYY-MM-DD format
                const year = parsed.getFullYear();
                const month = String(parsed.getMonth() + 1).padStart(2, '0');
                const day = String(parsed.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function importCSV(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvData = parseCSV(e.target.result);
                        const nameToId = {};
                        // First pass: create IDs and store temp data with parent info
                        const tempData = csvData.map((csvRow, index) => {
                            const id = String(Date.now() + index);
                            const name = csvRow.assignment_name || csvRow['assignment_name'] || '';
                            nameToId[name] = id;
                            return {
                                id: id,
                                parentId: null,
                                tempParentName: csvRow.parent_assignment_name || csvRow['parent_assignment_name'] || '',
                                name: name,
                                type: csvRow.type || predefinedTypes[0],
                                project: csvRow.project_name || csvRow['project_name'] || predefinedProjects[0],
                                responsible: csvRow.responsible || '',
                                deliveryDate: normalizeDateFormat(csvRow.delivery_date || csvRow['delivery_date'] || ''),
                                startDate: normalizeDateFormat(csvRow.start_date || csvRow['start_date'] || ''),
                                daysToDelivery: 0,
                                deadlineDate: normalizeDateFormat(csvRow.deadline_date || csvRow['deadline_date'] || ''),
                                progress: normalizeProgress(csvRow.progress),
                                notes: csvRow.notes || ''
                            };
                        });
                        // Second pass: set parentIds
                        tempData.forEach(item => {
                            if (item.tempParentName && nameToId[item.tempParentName]) {
                                item.parentId = nameToId[item.tempParentName];
                            }
                            delete item.tempParentName;
                        });
                        data = tempData;
                        localStorage.setItem('dashboardData', JSON.stringify(data));
                        // Reset filters on import to ensure all data visible by default
                        localStorage.removeItem('tableFilters');
                        renderTable();
                        updateDashboardIfVisible();
                        document.getElementById('debug').innerHTML = `Imported ${tempData.length} rows successfully (including multi-level children).`;
                    } catch (err) {
                        document.getElementById('debug').innerHTML = `Import error: ${err.message}`;
                    }
                };
                reader.readAsText(file);
            }
            const csvImport = document.getElementById('csvImport');
            const csvFile = document.getElementById('csvFile');
            const browseCsv = document.getElementById('browseCsv');
            browseCsv.addEventListener('click', () => {
                csvFile.click();
            });
            csvFile.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    importCSV(e.target.files[0]);
                }
            });
            csvImport.addEventListener('dragover', (e) => {
                e.preventDefault();
                csvImport.classList.add('dragover');
            });
            csvImport.addEventListener('dragleave', () => {
                csvImport.classList.remove('dragover');
            });
            csvImport.addEventListener('drop', (e) => {
                e.preventDefault();
                csvImport.classList.remove('dragover');
                if (e.dataTransfer.files[0] && e.dataTransfer.files[0].type === 'text/csv') {
                    importCSV(e.dataTransfer.files[0]);
                } else {
                    document.getElementById('debug').innerHTML = 'Please drop a valid CSV file.';
                }
            });
            // Filter functions
            const columns = ['Assignment Name', 'Type', 'Project Name', 'Responsible', 'Delivery Date', 'Days to Delivery', 'Deadline Date', 'Status', 'Progress', 'Notes', 'Actions'];
            const filterCols = [1, 2, 7, 8]; // Type, Project, Status, Progress
            window.toggleFilters = function() {
                const filterRow = document.querySelector('.filter-row');
                filterRow.classList.toggle('show');
            };
            window.updateFilter = function(col, value, checked) {
                let filters = JSON.parse(localStorage.getItem('tableFilters') || '{}');
                if (!filters[col]) filters[col] = [];
                const idx = filters[col].indexOf(value);
                if (checked) {
                    if (idx === -1) filters[col].push(value);
                } else {
                    if (idx > -1) filters[col].splice(idx, 1);
                }
                localStorage.setItem('tableFilters', JSON.stringify(filters));
                applyFilters();
                updateDashboardIfVisible();
            };
            function applyFilters() {
                let filters = JSON.parse(localStorage.getItem('tableFilters') || '{}');
                const rows = Array.from(document.querySelectorAll('#tableBody tr'));
                rows.forEach(tr => {
                    let show = true;
                    const cells = tr.querySelectorAll('td');
                    for (let col in filters) {
                        if (!show) break;
                        const filterVals = filters[col];
                        if (filterVals.length === 0) {
                            continue;
                        }
                        let cellVal = '';
                        const sel = cells[col].querySelector('select');
                        if (sel) {
                            cellVal = sel.value;
                        } else {
                            const spans = cells[col].querySelectorAll('span');
                            cellVal = Array.from(spans).map(s => s.textContent).join(' ');
                        }
                        if (!filterVals.includes(cellVal)) {
                            show = false;
                        }
                    }
                    tr.style.display = show ? '' : 'none';
                });
            }
            function getFilteredData() {
                let filters = JSON.parse(localStorage.getItem('tableFilters') || '{}');
                const flattened = getFlattened(data);
                return flattened.filter(row => {
                    const daysToDelivery = row.daysToDelivery || (row.deliveryDate && isValidDate(row.deliveryDate) ? Math.floor((new Date(row.deliveryDate) - today) / (1000 * 60 * 60 * 24)) : 0);
                    let status = computeStatus(daysToDelivery);
                    let progress = normalizeProgress(row.progress || 'Not Started');
                    if (progress === 'Complete/Accepted') status = 'Complete';
                
                    for (let col in filters) {
                        const filterVals = filters[col];
                        if (filterVals.length === 0) {
                            return false;
                        }
                        let cellVal = '';
                        if (col == 1) cellVal = row.type || '';
                        else if (col == 2) cellVal = row.project || '';
                        else if (col == 7) cellVal = status;
                        else if (col == 8) cellVal = progress;
                        if (!filterVals.includes(cellVal)) return false;
                    }
                    return true;
                });
            }
            // Modal functions
            window.closeModal = function() {
                document.getElementById('modal').style.display = 'none';
            };
            document.getElementById('closeModal').onclick = function() {
                closeModal();
            };
            window.onclick = function(event) {
                const modal = document.getElementById('modal');
                if (event.target == modal) {
                    closeModal();
                }
            };
            // Toggle Table
            document.getElementById('toggleTable').addEventListener('click', function() {
                const table = document.getElementById('dataTable');
                const btn = document.getElementById('toggleTable');
                if (table.style.display === 'none') {
                    table.style.display = 'table';
                    btn.textContent = 'Hide Table';
                } else {
                    table.style.display = 'none';
                    btn.textContent = 'Show Table';
                }
            });
            // Populate table
            function renderTable() {
                const flattened = getFlattened(data);
                // FIXED: Collect unique values dynamically for Type and Project filters
                const uniqueTypes = [...new Set(flattened.map(row => row.type || '').filter(t => t))].sort();
                const uniqueProjects = [...new Set(flattened.map(row => row.project || '').filter(p => p))].sort();
                const table = document.getElementById('dataTable');
                const thead = table.querySelector('thead');
                let filterRowHtml = '';
                columns.forEach((col, i) => {
                    if (filterCols.includes(i)) {
                        let checkboxes = '';
                        let options = [];
                        if (i === 1) options = uniqueTypes;
                        else if (i === 2) options = uniqueProjects;
                        else if (i === 7) options = statusOptions;
                        else if (i === 8) options = progressOptions;
                        options.forEach(opt => {
                            checkboxes += `<label><input type="checkbox" value="${opt}" onchange="updateFilter(${i}, '${opt}', this.checked)"> ${opt}</label>`;
                        });
                        filterRowHtml += `<th><div class="filter-group">${checkboxes}</div></th>`;
                    } else {
                        filterRowHtml += '<th></th>';
                    }
                });
                thead.innerHTML = `
                    <tr>
                        ${columns.map(col => `<th>${col}</th>`).join('')}
                    </tr>
                    <tr class="filter-row">
                        ${filterRowHtml}
                    </tr>
                `;
                // Load saved filters and correctly set checkbox states
                const filters = JSON.parse(localStorage.getItem('tableFilters') || '{}');
                // FIXED: Use dynamic options for initialization
                const optionsByCol = {
                    1: uniqueTypes, // Type - dynamic
                    2: uniqueProjects, // Project Name - dynamic
                    7: statusOptions, // Status
                    8: progressOptions // Progress
                };
                filterCols.forEach(colIdx => {
                    // Target the filter-row th
                    const th = document.querySelector(`.filter-row th:nth-child(${colIdx + 1})`);
                    if (!th) return;
                    const cbs = th.querySelectorAll('input[type="checkbox"]');
                    let savedFilter = filters[colIdx] || [];
                    const fullOptions = optionsByCol[colIdx] || [];
                    // If no saved filter (undefined), initialize to full options list
                    if (!filters[colIdx]) {
                        savedFilter = [...fullOptions];
                        filters[colIdx] = savedFilter;
                        localStorage.setItem('tableFilters', JSON.stringify(filters));
                    }
                    // Uncheck all first
                    cbs.forEach(cb => cb.checked = false);
                    // Check saved ones
                    savedFilter.forEach(val => {
                        const cb = Array.from(cbs).find(c => c.value === val);
                        if (cb) cb.checked = true;
                    });
                });
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                flattened.forEach((row) => {
                    const daysToDelivery = row.daysToDelivery || (row.deliveryDate && isValidDate(row.deliveryDate) ? Math.floor((new Date(row.deliveryDate) - today) / (1000 * 60 * 60 * 24)) : 0);
                    let status = computeStatus(daysToDelivery);
                    const progress = normalizeProgress(row.progress || 'Not Started');
                    const isComplete = progress === 'Complete/Accepted';
                    if (isComplete) status = 'Complete';
                    const rowStatusClass = isComplete ? 'complete' : status.toLowerCase().replace(' ', '-');
                    const displayStatus = isComplete ? 'Complete' : status;
                    const tr = document.createElement('tr');
                    tr.className = `status-${rowStatusClass}`;
                    const indentStyle = `padding-left: calc(8px + ${row.depth * 20}px);`; /* Base 8px + dynamic indentâ€”match your uniform padding */
                    tr.innerHTML = `
                        <td style="${indentStyle}"><input type="text" value="${row.name || ''}" onchange="updateData('${row.id}', 'name', this.value)"></td>
                        <td><select onchange="updateData('${row.id}', 'type', this.value)">${predefinedTypes.map(t => `<option ${row.type === t ? 'selected' : ''}>${t}</option>`).join('')}${row.type && !predefinedTypes.includes(row.type) ? `<option selected>${row.type}</option>` : ''}</select></td>
                        <td><select onchange="updateData('${row.id}', 'project', this.value)">${predefinedProjects.map(p => `<option ${row.project === p ? 'selected' : ''}>${p}</option>`).join('')}${row.project && !predefinedProjects.includes(row.project) ? `<option selected>${row.project}</option>` : ''}</select></td>
                        <td><input type="text" value="${row.responsible || ''}" onchange="updateData('${row.id}', 'responsible', this.value)"></td>
                        <td><input type="date" value="${row.deliveryDate || ''}" onchange="updateData('${row.id}', 'deliveryDate', this.value); calcDays('${row.id}')"></td>
                        <td><span>${daysToDelivery}</span></td>
                        <td><input type="date" value="${row.deadlineDate || ''}" onchange="updateData('${row.id}', 'deadlineDate', this.value)"></td>
                        <td><span class="status-${rowStatusClass}">${displayStatus}</span></td>
                        <td><select onchange="updateData('${row.id}', 'progress', this.value)" class="progress-${progress.toLowerCase().replace(' ', '-').replace('/', '-')}">${progressOptions.map(p => `<option ${progress === p ? 'selected' : ''}>${p}</option>`).join('')}</select></td>
                        <td><textarea rows="2" onchange="updateData('${row.id}', 'notes', this.value)">${row.notes || ''}</textarea></td>
                        <td><button onclick="addChild('${row.id}')">Add Child</button> <button onclick="deleteById('${row.id}')">Delete</button></td>
                    `;
                    tbody.appendChild(tr);
                });
                localStorage.setItem('dashboardData', JSON.stringify(data));
                applyFilters();
                document.getElementById('toggleFilters').onclick = toggleFilters;
            }
            window.updateData = function(id, key, value) {
                const index = data.findIndex(d => d.id === id);
                if (index === -1) return;
                data[index][key] = value;
                if (key === 'progress') {
                    data[index][key] = normalizeProgress(value);
                }
                if (key === 'deliveryDate') calcDays(id);
                localStorage.setItem('dashboardData', JSON.stringify(data));
                renderTable();
                updateDashboardIfVisible();
            };
            window.calcDays = function(id) {
                const index = data.findIndex(d => d.id === id);
                if (index === -1) return;
                if (!data[index].deliveryDate || !isValidDate(data[index].deliveryDate)) {
                    data[index].daysToDelivery = 0;
                    localStorage.setItem('dashboardData', JSON.stringify(data));
                    renderTable();
                    updateDashboardIfVisible();
                    return;
                }
                const delivery = new Date(data[index].deliveryDate);
                data[index].daysToDelivery = Math.floor((delivery - today) / (1000 * 60 * 60 * 24));
                localStorage.setItem('dashboardData', JSON.stringify(data));
                renderTable();
                updateDashboardIfVisible();
            };
            window.deleteById = function(id) {
                const children = getChildren(id);
                if (children.length > 0) {
                    alert('Cannot delete parent with children. Delete children first.');
                    return;
                }
                const index = data.findIndex(d => d.id === id);
                if (index > -1) {
                    data.splice(index, 1);
                    localStorage.setItem('dashboardData', JSON.stringify(data));
                    renderTable();
                    updateDashboardIfVisible();
                }
            };
            window.addChild = function(parentId) {
                const parentIndex = data.findIndex(d => d.id === parentId);
                if (parentIndex === -1) return;
                const parent = data[parentIndex];
                data.push({
                    id: String(Date.now()),
                    parentId: parentId,
                    project: parent.project || predefinedProjects[0],
                    type: parent.type || predefinedTypes[0],
                    name: '',
                    responsible: parent.responsible || '',
                    deliveryDate: parent.deliveryDate || '',
                    startDate: '',
                    daysToDelivery: 0,
                    deadlineDate: parent.deadlineDate || '',
                    progress: 'Not Started',
                    notes: ''
                });
                localStorage.setItem('dashboardData', JSON.stringify(data));
                renderTable();
                updateDashboardIfVisible();
            };
            document.getElementById('addRow').addEventListener('click', () => {
                data.push({
                    id: String(Date.now()),
                    parentId: null,
                    project: predefinedProjects[0],
                    type: predefinedTypes[0],
                    name: '',
                    responsible: '',
                    deliveryDate: '',
                    startDate: '',
                    daysToDelivery: 0,
                    deadlineDate: '',
                    progress: progressOptions[0],
                    notes: ''
                });
                localStorage.setItem('dashboardData', JSON.stringify(data));
                renderTable();
                updateDashboardIfVisible();
            });
            window.generateDashboard = function() {
                // Removed alert for empty data - allow empty dashboard
                console.log('Generating dashboard with data:', data); // Debug log
                document.querySelector('.input-section').style.display = 'block';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('debug').innerHTML = ''; // Clear debug
                const allData = getFilteredData();
                try {
                    // Analytics
                    const statusCounts = { 'Got Time': 0, 'At Risk': 0, Overdue: 0, Complete: 0 };
                    const progressCounts = { 'Not Started': 0, 'In Progress': 0, Submitted: 0, 'Complete/Accepted': 0 };
                    allData.forEach(item => {
                        const days = item.daysToDelivery || (item.deliveryDate && isValidDate(item.deliveryDate) ? Math.floor((new Date(item.deliveryDate) - today) / (1000 * 60 * 60 * 24)) : 0);
                        let status = computeStatus(days);
                        const progress = normalizeProgress(item.progress || 'Not Started');
                        if (progress === 'Complete/Accepted') status = 'Complete';
                        statusCounts[status]++;
                        progressCounts[progress]++;
                    });
                    document.getElementById('totalTasks').textContent = allData.length;
                    document.getElementById('gotTimeCount').textContent = statusCounts['Got Time'];
                    document.getElementById('atRiskCount').textContent = statusCounts['At Risk'];
                    document.getElementById('overdueCount').textContent = statusCounts.Overdue;
                    document.getElementById('notStartedCount').textContent = progressCounts['Not Started'];
                    document.getElementById('inProgressCount').textContent = progressCounts['In Progress'];
                    document.getElementById('submittedCount').textContent = progressCounts.Submitted;
                    document.getElementById('completeAcceptedCount').textContent = progressCounts['Complete/Accepted'];
                    // Upcoming Alerts
                    const alerts = { '30 Day Notices': [], 'Deliveries': [], Deadlines: [] };
                    allData.forEach(item => {
                        const title = `${item.project || ''} - ${item.type || ''}: ${item.name || ''}`;
                        // Delivery and 30 day notices based on delivery
                        if (item.deliveryDate && isValidDate(item.deliveryDate)) {
                            const delivDate = new Date(item.deliveryDate);
                            const daysToDeliv = Math.floor((delivDate - today) / (1000 * 60 * 60 * 24));
                            if (daysToDeliv >= 0) {
                                const delivColor = typeColors[item.type]?.atrisk || '#FFEB3B'; // Darker for Delivery
                                alerts['Deliveries'].push({ date: item.deliveryDate, title, days: daysToDeliv, color: delivColor });
                            }
                            const thirtyBefore = new Date(delivDate.getTime() - 30 * 24 * 60 * 60 * 1000);
                            const daysToThirty = Math.floor((thirtyBefore - today) / (1000 * 60 * 60 * 24));
                            if (daysToThirty >= 0) {
                                const thirtyColor = typeColors[item.type]?.safe || '#FF9800'; // Lighter for 30 Day
                                alerts['30 Day Notices'].push({ date: thirtyBefore.toISOString().split('T')[0], title, days: daysToThirty, color: thirtyColor });
                            }
                        }
                        // Deadlines
                        if (item.deadlineDate && isValidDate(item.deadlineDate)) {
                            const deadlDate = new Date(item.deadlineDate);
                            const daysToDeadl = Math.floor((deadlDate - today) / (1000 * 60 * 60 * 24));
                            if (daysToDeadl >= 0) {
                                const deadlColor = '#F44336';
                                alerts.Deadlines.push({ date: item.deadlineDate, title, days: daysToDeadl, color: deadlColor });
                            }
                        }
                    });
                    // Sort
                    Object.keys(alerts).forEach(key => alerts[key].sort((a, b) => new Date(a.date) - new Date(b.date)));
                    let alertsHtml = '';
                    Object.keys(alerts).forEach(key => {
                        if (alerts[key].length === 0) return;
                        alertsHtml += `<h3>${key}</h3><ul>`;
                        alerts[key].forEach(al => {
                            alertsHtml += `<li style="border-left: 4px solid ${al.color}; background-color: ${al.color.replace('#', '')}20;">${al.date} (${al.days} days): ${al.title}</li>`;
                        });
                        alertsHtml += '</ul>';
                    });
                    document.getElementById('alerts').innerHTML = alertsHtml;
                    // Status Pie Chart - Safe destroy
                    safeDestroy('statusChart');
                    const statusCtx = document.getElementById('statusChart').getContext('2d');
                    window.statusChart = new Chart(statusCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(statusCounts),
                            datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#81C784', '#FFEB3B', '#F44336', '#2E7D32'] }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { title: { display: true, text: 'Status Breakdown' } }
                        }
                    });
                    console.log('Status chart rendered');
                    // Progress Bar Chart - Safe destroy, integers on y
                    safeDestroy('progressChart');
                    const progressCtx = document.getElementById('progressChart').getContext('2d');
                    window.progressChart = new Chart(progressCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(progressCounts),
                            datasets: [{ label: 'Count', data: Object.values(progressCounts), backgroundColor: ['#9E9E9E', '#FF9800', '#2196F3', '#2E7D32'] }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { title: { display: true, text: 'Progress Breakdown' } },
                            legend: { display: false },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                    console.log('Progress chart rendered');
                    // Calendar - MultiMonth 4x2
                    const calendarEl = document.getElementById('calendar');
                    if (calendarEl._fullCalendar) {
                        calendarEl._fullCalendar.destroy();
                    }
                    calendarEl.innerHTML = ''; // Clear
                    const initialDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const minDate = new Date(initialDate);
                    const events = [];
                    allData.forEach(item => {
                        const shortTitle = `${item.project || 'Untitled'} - ${item.name || ''}`;
                        // Delivery event and 30 day notice
                        if (item.deliveryDate && isValidDate(item.deliveryDate)) {
                            const delivDate = new Date(item.deliveryDate);
                            const daysToDeliv = Math.floor((delivDate - today) / (1000 * 60 * 60 * 24));
                            if (daysToDeliv >= 0) {
                                events.push({
                                    title: `Delivery Date - ${shortTitle}`,
                                    start: item.deliveryDate,
                                    backgroundColor: typeColors[item.type]?.atrisk || '#FFEB3B' // Darker for Delivery
                                });
                            }
                            const thirtyBefore = new Date(delivDate.getTime() - 30 * 24 * 60 * 60 * 1000);
                            const daysToThirty = Math.floor((thirtyBefore - today) / (1000 * 60 * 60 * 24));
                            if (daysToThirty >= 0) {
                                events.push({
                                    title: `30 Day Notice - ${shortTitle}`,
                                    start: thirtyBefore.toISOString().split('T')[0],
                                    backgroundColor: typeColors[item.type]?.safe || '#FF9800' // Lighter for 30 Day
                                });
                            }
                        }
                        // Deadline event
                        if (item.deadlineDate && isValidDate(item.deadlineDate)) {
                            const deadlDate = new Date(item.deadlineDate);
                            const daysToDeadl = Math.floor((deadlDate - today) / (1000 * 60 * 60 * 24));
                            if (daysToDeadl >= 0) {
                                events.push({
                                    title: `Deadline - ${shortTitle}`,
                                    start: item.deadlineDate,
                                    backgroundColor: '#F44336'
                                });
                            }
                        }
                    });
                    console.log('Calendar events:', events);
                    const calendar = new FullCalendar.Calendar(calendarEl, {
                        initialDate: initialDate,
                        initialView: 'multiMonth',
                        duration: { months: 8 },
                        multiMonthMaxColumns: 4,
                        showNonCurrentDates: false,
                        events: events,
                        height: 'auto', // Auto height to fit content
                        headerToolbar: {
                            left: '',
                            center: 'title',
                            right: ''
                        },
                        dateClick: function(info) {
                            showCalendarEvents(info.dateStr);
                        },
                        eventClick: function(info) {
                            showCalendarEvents(info.event.start.toISOString().split('T')[0]);
                        }
                    });
                    function showCalendarEvents(dateStr) {
                        const eventsOnDate = calendar.getEvents().filter(event => {
                            const eventStart = event.start ? event.start.toISOString().split('T')[0] : null;
                            return eventStart === dateStr;
                        });
                        let content = `<h3>Events on ${dateStr}:</h3>`;
                        if (eventsOnDate.length > 0) {
                            eventsOnDate.forEach(event => {
                                content += `<p>${event.title}</p>`;
                            });
                        } else {
                            content = `<p>No events on ${dateStr}</p>`;
                        }
                        document.getElementById('modalBody').innerHTML = content;
                        document.getElementById('modal').style.display = 'block';
                    }
                    calendarEl._fullCalendar = calendar;
                    calendar.render();
                    // Calendar controls
                    const cal = calendarEl._fullCalendar;
                    const updateCalTitle = () => {
                        document.getElementById('calTitle').textContent = cal.view.title;
                    };
                    document.getElementById('calPrev').onclick = () => {
                        const current = cal.getDate();
                        let newMonth = current.getMonth() - 1;
                        let newYear = current.getFullYear();
                        if (newMonth < 0) {
                            newMonth = 11;
                            newYear--;
                        }
                        const proposed = new Date(newYear, newMonth, 1);
                        if (proposed < minDate) {
                            return;
                        }
                        cal.gotoDate(proposed);
                        updateCalTitle();
                    };
                    document.getElementById('calNext').onclick = () => {
                        const current = cal.getDate();
                        let newMonth = current.getMonth() + 1;
                        let newYear = current.getFullYear();
                        if (newMonth > 11) {
                            newMonth = 0;
                            newYear++;
                        }
                        const proposed = new Date(newYear, newMonth, 1);
                        cal.gotoDate(proposed);
                        updateCalTitle();
                    };
                    document.getElementById('calToday').onclick = () => {
                        cal.today();
                        updateCalTitle();
                    };
                    updateCalTitle();
                    console.log('Calendar rendered');
                    // Gantt Table - Dynamic from 1 month prior to +2 years (to include 2027)
                    const ganttEl = document.getElementById('gantt');
                    ganttEl.innerHTML = '';
                    const startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(today.getFullYear() + 2, 11, 31);
                    endDate.setHours(0, 0, 0, 0);
                    // Generate week starts (Sundays), starting from the Sunday of or before the week containing startDate
                    let currentSunday = new Date(startDate);
                    let day = currentSunday.getDay();
                    // day 0 = Sunday, so subtract day to get to previous/current Sunday
                    currentSunday.setDate(currentSunday.getDate() - day);
                    currentSunday.setHours(0, 0, 0, 0);
                    let weekStarts = [];
                    while (currentSunday <= endDate) {
                        weekStarts.push(getLocalDateString(currentSunday));
                        currentSunday.setDate(currentSunday.getDate() + 7);
                    }
                    // Find today week index - find the Sunday that starts the week containing today
                    let todayWeekIndex = -1;
                    const todayDayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
                    const todaySunday = new Date(today);
                    todaySunday.setDate(today.getDate() - todayDayOfWeek);
                    todaySunday.setHours(0, 0, 0, 0);
                    const todaySundayStr = getLocalDateString(todaySunday);

                    console.log('=== DEBUG INFO ===');
                    console.log('Today raw:', today);
                    console.log('Today formatted:', getLocalDateString(today));
                    console.log('Today day of week:', todayDayOfWeek, '(0=Sun, 1=Mon, etc)');
                    console.log('Today Sunday calculated:', todaySundayStr);
                    console.log('First 15 week starts:', weekStarts.slice(0, 15));
                    console.log('StartDate:', getLocalDateString(startDate));
                    console.log('First Sunday:', weekStarts[0]);

                    for (let i = 0; i < weekStarts.length; i++) {
                        if (weekStarts[i] === todaySundayStr) {
                            todayWeekIndex = i;
                            console.log('âœ“ Found today week at index:', i, 'Week starts:', weekStarts[i]);
                            console.log('Column position will be:', 300 + (i * 35), 'px');
                            break;
                        }
                    }
                    if (todayWeekIndex === -1) {
                        console.log('âš  WARNING: Could not find today week');
                        console.log('Looking for:', todaySundayStr);
                        console.log('Available weeks:', weekStarts.slice(0, 20));
                        todayWeekIndex = 0;
                    }
                    console.log('=================');
                    // Month starts and colspans, starting from the month of the first week
                    const firstParts = weekStarts[0].split('-');
                    const firstWeekDate = new Date(parseInt(firstParts[0]), parseInt(firstParts[1]) - 1, parseInt(firstParts[2]));
                    let m = new Date(firstWeekDate.getFullYear(), firstWeekDate.getMonth(), 1);
                    const monthStarts = [];
                    while (m <= endDate) {
                        monthStarts.push(new Date(m));
                        m.setMonth(m.getMonth() + 1);
                    }
                    const colspans = monthStarts.map(ms => {
                        let count = 0;
                        for (let ws of weekStarts) {
                            const wsD = new Date(ws);
                            if (wsD.getMonth() === ms.getMonth() && wsD.getFullYear() === ms.getFullYear()) count++;
                        }
                        return count;
                    });
                    const monthNamesFull = monthStarts.map(ms => ms.toLocaleString('en-US', { month: 'long' }).toUpperCase());
                    let table = document.createElement('table');
                    let thead = document.createElement('thead');
                    // Year header row
                    let yearTr = document.createElement('tr');
                    let leftHeaderTh = document.createElement('th');
                    leftHeaderTh.textContent = 'Project / Assignment';
                    leftHeaderTh.rowSpan = 1;
                    leftHeaderTh.className = 'left-header';
                    yearTr.appendChild(leftHeaderTh);
                    // Group months by year for year colspans
                    let yearGroups = [];
                    let i = 0;
                    while (i < monthStarts.length) {
                        let y = monthStarts[i].getFullYear();
                        let sumC = 0;
                        while (i < monthStarts.length && monthStarts[i].getFullYear() === y) {
                            sumC += colspans[i];
                            i++;
                        }
                        yearGroups.push({year: y, colspan: sumC});
                    }
                    yearGroups.forEach(group => {
                        let yearTh = document.createElement('th');
                        yearTh.textContent = group.year;
                        yearTh.colSpan = group.colspan;
                        yearTh.className = 'year-header';
                        yearTr.appendChild(yearTh);
                    });
                    thead.appendChild(yearTr);
                    // Month header row
                    let monthTr = document.createElement('tr');
                    let leftEmptyThMonth = document.createElement('th');
                    leftEmptyThMonth.className = 'left-header';
                    leftEmptyThMonth.textContent = '';
                    monthTr.appendChild(leftEmptyThMonth);
                    colspans.forEach((span, mi) => {
                        let monthTh = document.createElement('th');
                        monthTh.textContent = monthNamesFull[mi];
                        monthTh.colSpan = span;
                        monthTh.className = 'month';
                        monthTr.appendChild(monthTh);
                    });
                    thead.appendChild(monthTr);
                    // Week start days row
                    let weekTr = document.createElement('tr');
                    let leftEmptyThWeek = document.createElement('th');
                    leftEmptyThWeek.className = 'left-header';
                    leftEmptyThWeek.textContent = '';
                    weekTr.appendChild(leftEmptyThWeek);
                    weekStarts.forEach((ws, i) => {
                        let dayTh = document.createElement('th');
                        // Parse the date string properly to avoid timezone issues
                        const parts = ws.split('-');
                        const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        dayTh.textContent = d.getDate();
                        dayTh.className = 'week-start';
                        weekTr.appendChild(dayTh);
                    });
                    thead.appendChild(weekTr);
                    let tbody = document.createElement('tbody');
                    // Use filtered data for Gantt to respect filters
                    const ganttFullData = getFilteredData().filter(item => item.deliveryDate && isValidDate(item.deliveryDate));
                    let currentProject = null;
                    ganttFullData.forEach((item) => {
                        const progressItem = normalizeProgress(item.progress || 'Not Started');
                        const isComplete = progressItem === 'Complete/Accepted';
                        let startDateTask = null;
                        let endDateTask = null;
                        let delivDateTask = null;
                        let deadlDateTask = null;
                        delivDateTask = new Date(item.deliveryDate);
                        deadlDateTask = item.deadlineDate && isValidDate(item.deadlineDate) ? new Date(item.deadlineDate) : delivDateTask;
                        if (item.startDate && isValidDate(item.startDate)) {
                            startDateTask = new Date(item.startDate);
                        } else if (isComplete) {
                            startDateTask = delivDateTask;
                        } else {
                            if (delivDateTask < today) {
                                startDateTask = delivDateTask;
                            } else {
                                startDateTask = today;
                            }
                        }
                        if (isComplete) {
                            endDateTask = new Date(Math.max(delivDateTask.getTime(), today.getTime()));
                        } else {
                            const maxDue = new Date(Math.max(delivDateTask.getTime(), deadlDateTask.getTime()));
                            endDateTask = maxDue;
                        }
                        if (item.project !== currentProject) {
                            // Project header
                            let trP = document.createElement('tr');
                            let tdPLeft = document.createElement('td');
                            tdPLeft.textContent = item.project || 'Untitled Project';
                            tdPLeft.colSpan = 1;
                            tdPLeft.className = 'phase-header';
                            trP.appendChild(tdPLeft);
                            let tdPTime = document.createElement('td');
                            tdPTime.colSpan = weekStarts.length;
                            tdPTime.className = 'phase-header';
                            tdPTime.style.backgroundColor = '#f1f5f9';
                            trP.appendChild(tdPTime);
                            tbody.appendChild(trP);
                            currentProject = item.project;
                        }
                        // Task row
                        let trTask = document.createElement('tr');
                        let tdName = document.createElement('td');
                        tdName.textContent = item.name;
                        tdName.className = 'task-name';
                        tdName.style.paddingLeft = (item.depth * 20 + 10) + 'px';
                        // For complete, keep white background and black text like others
                        trTask.appendChild(tdName);
                        weekStarts.forEach((ws, i) => {
                            let weekStart = new Date(ws);
                            let weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                            let cell = document.createElement('td');
                            cell.className = 'task-cell';
                            if (startDateTask && endDateTask && startDateTask < weekEnd && endDateTask > weekStart) {
                                let cellColor;
                                if (isComplete) {
                                    cellColor = '#2E7D32';
                                } else {
                                    const delivTime = delivDateTask.getTime();
                                    const deadlTime = deadlDateTask.getTime();
                                    const thirtyTime = delivTime - 30 * 24 * 60 * 60 * 1000;
                                    const weekStartTime = weekStart.getTime();
                                    const weekEndTime = weekEnd.getTime();
                                    const weekMidTime = weekStartTime + (weekEndTime - weekStartTime) / 2;
                                    // Removed red deadline marking
                                    if (delivTime <= deadlTime && weekMidTime >= delivTime && weekMidTime < deadlTime) {
                                        cellColor = typeColors[item.type]?.complete || '#2E7D32'; // darker
                                    } else if (weekMidTime >= delivTime) {
                                        cellColor = typeColors[item.type]?.atrisk || '#FFEB3B'; // medium
                                    } else if (weekMidTime > thirtyTime) {
                                        cellColor = typeColors[item.type]?.atrisk || '#FFEB3B';
                                    } else {
                                        cellColor = typeColors[item.type]?.safe || '#4CAF50';
                                    }
                                }
                                cell.style.backgroundColor = cellColor;
                            }
                            trTask.appendChild(cell);
                        });
                        tbody.appendChild(trTask);
                    });
                    table.appendChild(thead);
                    table.appendChild(tbody);
                    // Increased width calculation based on new cell sizes
                    table.style.width = (300 + weekStarts.length * 35) + 'px';
                    ganttEl.appendChild(table);
                    // Dynamic height for Gantt container
                    const ganttContainer = document.querySelector('.gantt-container');
                    ganttContainer.style.height = (table.offsetHeight + 20) + 'px';
                    // Add continuous blue line overlay at the start of current week
                    if (todayWeekIndex >= 0) {
                        ganttEl.style.position = 'relative';

                        // More robust: measure the actual position of the target column
                        // Get the header row with week days
                        const weekHeaderRow = table.querySelector('thead tr:last-child');
                        if (weekHeaderRow) {
                            // Get all week header cells (skip first which is the left header)
                            const weekCells = Array.from(weekHeaderRow.querySelectorAll('th.week-start'));

                            if (weekCells[todayWeekIndex]) {
                                // Get the actual left position of the target column
                                const targetCell = weekCells[todayWeekIndex];
                                const tableRect = table.getBoundingClientRect();
                                const cellRect = targetCell.getBoundingClientRect();

                                // Position at the outer left edge (where the border starts)
                                const columnLeft = cellRect.left - tableRect.left;

                                console.log('Drawing line at:', columnLeft, 'px (measured from DOM) for week index:', todayWeekIndex, 'Sunday:', todaySundayStr);

                                const lineDiv = document.createElement('div');
                                lineDiv.style.cssText = `
                                    position: absolute;
                                    left: ${columnLeft}px;
                                    top: 0;
                                    bottom: 0;
                                    width: 3px;
                                    background-color: #6366f1;
                                    z-index: 10;
                                    pointer-events: none;
                                `;
                                ganttEl.appendChild(lineDiv);
                            } else {
                                console.warn('Could not find target week cell at index:', todayWeekIndex);
                            }
                        }
                    }
                    console.log('Gantt table rendered');
                } catch (err) {
                    console.error('Dashboard error:', err);
                    document.getElementById('debug').innerHTML = `Error: ${err.message}. Check console.`;
                }
            };
            document.getElementById('generateDashboard').addEventListener('click', generateDashboard);
            // Initial render
            renderTable();
        });
    </script>
</body>
</html>
